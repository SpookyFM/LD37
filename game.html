<html>

<head>
    <title>LD 37 - SpookyFM</title>
</head>

<body>
    <script src="js/three.min.js"></script>
    <script type='text/javascript' src='js/DAT.GUI.min.js'></script>
    <script src="js/player.js"></script>
    <script src="js/resource.js"></script>
    <script src="js/base.js"></script>
    <script src="js/controller.js"></script>

    <script>
        var camera, scene, renderer;

        // Time until the end of the game, in seconds
        var totalTime = 60 * 3;    
         
        // The player's base
        var base;
    
        var remainingTime = totalTime;

        // Camera height over the playing field
        var cameraHeight = 800;

        // Number of resources to randomly place
        var numResources = 100;

        var extents = 100 * 100; // 100 meters in each direction
        
        // The initial position of the player
        var spawnPosition = new THREE.Vector3(0, 0, 0);

        var floor;

        var player;

        var clock = new THREE.Clock();

        var resources = new Array();

        var gui = new dat.GUI();

        var resourceRadius = 20;
        var resourceGeometry = new THREE.SphereGeometry(resourceRadius, 32, 32);
        var resourceMaterial = new THREE.MeshBasicMaterial({
            color: 0xff0000
        });
        
        var numTimesButtonPressed = 0;

        // The object that the UI binds to for getting values
        var parameters = {
            currentResources: 0, 
            health: 100,
            remainingTimeText : 'remaining',
            buildNextPart : function()
            {
                numTimesButtonPressed++;
                if (numTimesButtonPressed % 2 == 0)
                {
                    // For some reason, I get two times the button. It's probably the enable/disable code
                    base.buildNextPart(player);
                }
            }
        };

        init();
        animate();

        function onTimeElapsed()
        {
            alert("Time is up!");
        }
        
        function onBaseFullyBuilt()
        {
            console.log("You is a winner!");
        }
        
        function onKeyDown(event) {
            switch (event.keyCode) {
                case 38: // up
                case 87: // w
                    player.moveDirection.UP = true;
                    break;
                case 37: // left
                case 65: // a
                    player.moveDirection.LEFT = true;
                    break;
                case 40: // down
                case 83: // s
                    player.moveDirection.DOWN = true;
                    break;
                case 39: // right
                case 68: // d
                    player.moveDirection.RIGHT = true;
                    break;
                case 32: // space
                    // Cheat: Give full resources
                    player.resources = player.maxResources;
                    player.health = player.maxHealth;
                    break;
            }
        }

        function onKeyUp(event) {
            switch (event.keyCode) {
                case 38: // up
                case 87: // w
                    player.moveDirection.UP = false;
                    break;
                case 37: // left
                case 65: // a
                    player.moveDirection.LEFT = false;
                    break;
                case 40: // down
                case 83: // s
                    player.moveDirection.DOWN = false;
                    break;
                case 39: // right
                case 68: // d
                    player.moveDirection.RIGHT = false;
                    break;
                case 32: // space
                    // player.jump();
                    break;
            }
        }


        function de2ra(degree) {
            return degree * (Math.PI / 180);
        }


        function placeResources() {
            for (var i = 0; i < numResources; i++) {
                placeResource();
            }
        }



        function placeResource() {
            // Generate a random position
            var posX = Math.random() * extents * 1;
            var posZ = Math.random() * extents * 1;


            var position = new THREE.Vector3(posX, 0, posZ);




            var resource = new Resource(resourceGeometry, resourceMaterial);
            resource.radius = resourceRadius;
            scene.add(resource);
            //resource.position = position;
            // TODO: No idea why this is necessary
            resource.position.x = position.x;
            resource.position.z = position.z;
            resources.push(resource);
        }

        // Checks all resources for intersection
        function checkResources() {
            var playerSphere = player.getCollisionSphere();
            for (var i = 0; i < resources.length; i++) {
                resource = resources[i];
                // Get the resource sphere and intersect it with the player
                var resourceSphere = resource.getCollisionSphere();
                if (playerSphere.intersectsSphere(resourceSphere)) {
                    // Give the resources to the player
                    player.giveResources(resource.resources);
                    
                    // TODO: Placeholder code for death testing only
                    var isDead = !player.reduceHealth(resource.resources);
                    if (isDead)
                    {
                        // Handle player death
                        player.reset();
                        return;
                    }

                    // Remove the resource from the array and from the scene
                    resources.splice(i, 1);
                    scene.remove(resource);
                    i--;
                }
            }
        }
        
        var currentResourcesProgressBar;
        var healthProgressBar;
        var buttonBuildNextPart;
    
        function updateUI() {
            parameters.currentResources = player.resources;            
            currentResourcesProgressBar.__max = player.maxResources;
            parameters.health = player.health;
            healthProgressBar.__max = player.maxHealth;
            
            // Format the time
            var minutes = Math.floor(remainingTime / 60);
            var seconds = Math.floor(remainingTime % 60);
            parameters.remainingTimeText = minutes + ':' + seconds;
            
            // Button enabled state
            var canBuild = base.canBuildNextPart(player);
            buttonBuildNextPart.disabled = !canBuild;
            // Get the name for the button
            buttonBuildNextPart.__button.innerHTML = base.getBuildText();
        }

        
        
        function initUI() {
            currentResourcesProgressBar = gui.add(parameters, 'currentResources', 0, 200).name('Resources').listen();
            
            healthProgressBar = gui.add(parameters, 'health',
                0, 100).name('Health').listen();
            
            gui.add(parameters, 'remainingTimeText').name("Remaining Time").listen();
            
            buttonBuildNextPart = gui.add(parameters, 'buildNextPart').name("Build");

            gui.open();
        }


        function init() {


            // Add the key down and up listeners
            document.addEventListener('keydown', onKeyDown, false);
            document.addEventListener('keyup', onKeyUp, false);


            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 10000);
            camera.position.y = cameraHeight;

            var lookAtPoint = new THREE.Vector3(0, 0, 0);
            camera.lookAt(lookAtPoint);

            scene = new THREE.Scene();

            renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);

            document.body.appendChild(renderer.domElement);

            /* Light */
            var light = new THREE.DirectionalLight(0xffffff);
            light.position.set(0, 1, 1).normalize();
            scene.add(light);


            /* Floor  */

            var floorGeometry = new THREE.PlaneGeometry(extents, extents, 1, 1);
            // var floorMaterial = new THREE.MeshBasicMaterial( { color: 0x0000ff, wireframe: true} );


            var floorMaterial = new THREE.MeshPhongMaterial({
                map: THREE.ImageUtils.loadTexture('textures/03intonacorovinato.jpg')
            });


            floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.material.side = THREE.DoubleSide;
            floor.rotateX(de2ra(90));

            /* Player */
            var playerRadius = 40;
            var playerGeometry = new THREE.SphereGeometry(playerRadius, 32, 32);
            var playerMaterial = new THREE.MeshBasicMaterial({
                color: 0xffff00
            });
            player = new Player(playerGeometry, playerMaterial);
            player.Radius = playerRadius;
            scene.add(player);


            scene.add(floor);

            placeResources();
            
            
            // Base
            base = new Base();

            initUI();

        }

        function animate() {

            requestAnimationFrame(animate);
            var delta = clock.getDelta();
            
            remainingTime -= delta;
            
            if (remainingTime < 0)
            {
                onTimeElapsed();
            }
            
            if (base.isFullyBuilt())
            {
                onBaseFullyBuilt();
            }
            
            // Update the player
            player.update(delta);

            // Move the camera over the player
            camera.position.x = player.position.x;
            camera.position.z = player.position.z;
            camera.lookAt(player.position);

            // Check for collisions with the resources
            checkResources();

            updateUI();
            
            

            renderer.render(scene, camera);

        }
    </script>
</body>

</html>